<html>
		<head>
				<script src="rx.js"></script> 
				<script src="rx-dom.js"></script> 
				<title>Hello Sudoku</title>
		</head>
		<body>

				<canvas id="mycanvas" width="600px" height="600px">

				</canvas>	

				<button onclick="showAnswer()">Show more numbers</button>
				<button onclick="emptyGame()">Clear sudoku</button>
				<button onclick="createGame()">Sudoku game 1</button>
				<button onclick="createGame3()">Sudoku game 2</button>
		</body>
		<script>

/*
*todo: fix so correct number on correct place 
 *
 */
		var canvas = document.getElementById("mycanvas");

		var globalMarkerBox = {width:500/9, height:500/9, xpos:0, ypos:0};
var globalPreNumbers = [
]
//createGame();
//createGame3();

function createGame(){

		emptyGame();

		globalPreNumbers = [{"row":0,"column":0,"value":5},{"row":0,"column":2,"value":8},{"row":2,"column":2,"value":6},{"row":2,"column":1,"value":9},{"row":2,"column":5,"value":7},{"row":1,"column":3,"value":9},{"row":0,"column":4,"value":3},{"row":2,"column":8,"value":3},{"row":3,"column":8,"value":2},{"row":3,"column":6,"value":3},{"row":4,"column":8,"value":7},{"row":5,"column":7,"value":1},{"row":5,"column":6,"value":9},{"row":5,"column":4,"value":2},{"row":4,"column":4,"value":1},{"row":4,"column":5,"value":9},{"row":3,"column":4,"value":7},{"row":4,"column":3,"value":8},{"row":3,"column":2,"value":5},{"row":3,"column":1,"value":1},{"row":4,"column":0,"value":3},{"row":5,"column":0,"value":8},{"row":5,"column":2,"value":7},{"row":6,"column":0,"value":7},{"row":6,"column":3,"value":5},{"row":7,"column":5,"value":8},{"row":8,"column":4,"value":6},{"row":6,"column":6,"value":6},{"row":6,"column":7,"value":9},{"row":8,"column":6,"value":2},{"row":8,"column":8,"value":4}];


		updateSudoku(canvas, globalPreNumbers, globalMarkerBox);
}

function createGame3(){
		console.log("createGame3");
		emptyGame();

		globalPreNumbers = [{"row":0,"column":0,"value":6},{"row":1,"column":2,"value":9},{"row":0,"column":3,"value":8},{"row":1,"column":3,"value":2},{"row":2,"column":5,"value":5},{"row":0,"column":6,"value":2},{"row":0,"column":7,"value":4},{"row":0,"column":8,"value":1},{"row":1,"column":8,"value":3},{"row":1,"column":7,"value":7},{"row":2,"column":8,"value":6},{"row":3,"column":7,"value":2},{"row":4,"column":7,"value":3},{"row":4,"column":6,"value":6},{"row":4,"column":8,"value":7},{"row":5,"column":6,"value":9},{"row":5,"column":3,"value":4},{"row":3,"column":5,"value":9},{"row":3,"column":2,"value":8},{"row":4,"column":2,"value":2},{"row":4,"column":1,"value":4},{"row":4,"column":0,"value":9},{"row":5,"column":1,"value":7},{"row":6,"column":0,"value":2},{"row":7,"column":0,"value":5},{"row":7,"column":1,"value":3},{"row":8,"column":0,"value":8},{"row":8,"column":1,"value":9},{"row":8,"column":2,"value":6},{"row":6,"column":3,"value":6},{"row":7,"column":5,"value":8},{"row":8,"column":5,"value":3},{"row":7,"column":6,"value":1},{"row":8,"column":8,"value":4}];
	
		updateSudoku(canvas, globalPreNumbers, globalMarkerBox);

}


function emptyGame(){

	globalPreNumbers.forEach(function(cell){

		cell.value = 0;

	});

	updateSudoku(canvas, globalPreNumbers, globalMarkerBox);

}


function createGame2(){

		emptyGame();

		globalPreNumbers = [{"row":0,"column":0,"value":5},{"row":0,"column":1,"value":6},{"row":0,"column":4,"value":2},{"row":0,"column":7,"value":1},{"row":1,"column":0,"value":9},{"row":1,"column":4,"value":5},{"row":1,"column":8,"value":7},{"row":2,"column":1,"value":3},{"row":2,"column":5,"value":1},{"row":2,"column":7,"value":8},{"row":2,"column":8,"value":9},{"row":3,"column":2,"value":1},{"row":3,"column":3,"value":2},{"row":3,"column":5,"value":9},{"row":3,"column":8,"value":8},{"row":5,"column":1,"value":2},{"row":5,"column":4,"value":4},{"row":6,"column":2,"value":9},{"row":6,"column":5,"value":7},{"row":7,"column":0,"value":1},{"row":7,"column":4,"value":3},{"row":7,"column":7,"value":2},{"row":8,"column":0,"value":6},{"row":8,"column":2,"value":3},{"row":8,"column":6,"value":7},{"row":8,"column":7,"value":5},{"row":1,"column":1,"value":0},{"row":2,"column":2,"value":0},{"row":0,"column":3,"value":0},{"row":2,"column":6,"value":0},{"row":1,"column":7,"value":0},{"row":1,"column":6,"value":0},{"row":4,"column":8,"value":0},{"row":5,"column":8,"value":0},{"row":5,"column":7,"value":0},{"row":4,"column":1,"value":0},{"row":6,"column":0,"value":0},{"row":8,"column":4,"value":0},{"row":8,"column":5,"value":0},{"row":7,"column":6,"value":0},{"row":6,"column":6,"value":0}];
		
	updateSudoku(canvas, globalPreNumbers, globalMarkerBox);

}


//numbersToAdd: {row, column, value}
function generateNumberArray(numbersToAdd){	
		numbersToAdd = numbersToAdd || [];
		var numberArr = [];
		for(var i = 0; i < 9; i++){

				for(var j = 0; j < 9; j++){

						//we have to check if we want to add the number
						var maybeNumber = numbersToAdd.find(function(cellObj){
								return cellObj.row === i && cellObj.column === j;

						});

						//if we found a value add it
						var value = (maybeNumber === undefined)? 0 : maybeNumber.value;


						var cell = {row:i, column:j, value:value};	
						numberArr.push(cell);						

				}
		}
		return numberArr;
}


function printSomething(something){
		console.log("someThing",something);
}

function checkOkayKey(keyObject, allowedKeys){
		return allowedKeys.some(function(keyString){return keyObject === keyString; });
}

function checkYDir(keyObject){
		var allowedKeys = ["ArrowDown", "ArrowUp" ];
		return checkOkayKey(keyObject, allowedKeys);

}

function checkNumberKey(keyObject){
		var allowedKeys = ["1", "2", "3","4","5", "6", "7", "8", "9", "0"];
		return checkOkayKey(keyObject, allowedKeys);

}

function checkEnterKey(keyObject){
		var allowedKeys = ["Enter"];
		return checkOkayKey(keyObject, allowedKeys);

}

function checkXDir(keyObject){

		var allowedKeys = ["ArrowLeft", "ArrowRight"];

		return checkOkayKey(keyObject, allowedKeys);

}

function updateGlobalBox(clickString){
		switch(clickString){
				case "ArrowUp":
						globalMarkerBox = generatePositionBox(globalMarkerBox, {x:0, y:-1});
						break;

				case "ArrowDown":
						globalMarkerBox = generatePositionBox(globalMarkerBox, {x:0, y:1});
						break;

				case "ArrowRight":
						globalMarkerBox = generatePositionBox(globalMarkerBox, {x:1, y:0});
						break;

				case "ArrowLeft":
						globalMarkerBox = generatePositionBox(globalMarkerBox, {x:-1, y:0});
						break;

				default:
						console.log("error input given");
						break;

		}

}



function addNumberToPreNumber(clickString){
		var row = Math.round(globalMarkerBox.ypos / globalMarkerBox.height);
		var column = Math.round(globalMarkerBox.xpos / globalMarkerBox.width);

		//remove existing values
		globalPreNumbers = globalPreNumbers.filter(function(cell){
				return !(cell.row === row && cell.column === column);
		});



		globalPreNumbers.push({row:row, column: column, value:parseInt(clickString)});
}

function setCell(row, column,value){

		globalPreNumbers.push({row:row, column:column, value:value});
}


function generatePositionBox(box, directionVector){

		return {width:box.width, height:box.height,xpos:  box.xpos + box.width * directionVector.x,ypos: box.ypos + box.height * directionVector.y} 

}

var allKeys = Rx.Observable.fromEvent(document, "keyup");

var ykeyUps = Rx.Observable.fromEvent(document,"keyup").map(function(keyObject){return keyObject.key}).filter(checkYDir);
var xkeyUps = Rx.Observable.fromEvent(document,"keyup").map(function(keyObject){return keyObject.key}).filter(checkXDir);
var numberKeys = Rx.Observable.fromEvent(document,"keyup").map(function(keyObject){return keyObject.key}).filter(checkNumberKey);

ykeyUps.subscribe(updateGlobalBox);
xkeyUps.subscribe(updateGlobalBox);

numberKeys.subscribe(addNumberToPreNumber);

allKeys.subscribe(function(){
		updateSudoku(canvas, globalPreNumbers, globalMarkerBox);		
});

function getAnswer(sudokuArr){
		var arguments = "sudokuToSolve=" + JSON.stringify(sudokuArr);									
		Rx.DOM.get('/solve' + "?" + arguments)
				.subscribe(
								function (xhr) {
										var text = xhr.response;
										globalPreNumbers = JSON.parse(text);


										//removes all the undefined values
										globalPreNumbers = globalPreNumbers.filter(function(cell){
												return cell.value !== undefined;
										});

										updateSudoku(canvas, globalPreNumbers, globalMarkerBox);
										console.log("testing");
								},
								function (err) {
										console.log("err",err);
										// Log the error
								}
						  );

}

function drawSudoku(canvas, preNumbers){
		var lineWidthBorder = 10;
		var lineWidthBigBox = 5;
		var lineWidthSmallBox =2 ;



		//using an object as repr of box border = {width, height, xpos,yos}
		var	border = {width:500, height:500, xpos: 0, ypos:0};


		//border
		drawSquare(canvas, border, lineWidthBorder);

		//big boxes
		var bigBoxes = generateInnerSquares(border);

		bigBoxes.forEach(function(box){
				drawSquare(canvas,box, lineWidthBigBox);
		});


		//text boxes
		var textBoxes = generateAllTextBoxes(border);

		//generate small boxes
		textBoxes.forEach(function(smallBox){
				drawSquare(canvas, smallBox, lineWidthSmallBox);

		});


		//drawText, preNumbers is the numbers given on startup
		var values = generateNumberArray(preNumbers);

		//remove non set values
		var filteredValues = values.filter(function(valueCell){
				return valueCell.value !== 0;

		});

		//draw every value
		filteredValues.forEach(function(valueCell){

				var correspondingBox = textBoxes.find(function(box){

						return box.xpos === box.width * valueCell.column && box.ypos === box.height * valueCell.row;

				});
				drawTextInBox(canvas, correspondingBox, valueCell.value);
		});
		["ArrowDown", "ArrowUp", "ArrowLeft", "ArrowRight" ]



}

function drawTextInBox(canvas, box, text){
		var ctx = canvas.getContext("2d");
		ctx.font = "30px Arial";
		ctx.textBaseline = "middle";
		ctx.textAlign = "center";
		ctx.fillText(text,box.xpos + box.width / 2,box.ypos + box.height /2);

		ctx.stroke();
}

function generateAllTextBoxes(borderBox){
		var bigBoxes = generateInnerSquares(borderBox);
		var textBoxes = [];
		bigBoxes.forEach(function(box){
				textBoxes = textBoxes.concat(generateInnerSquares(box));
		});

		return textBoxes;

}

function generateInnerSquares(box){
		var smallerBoxes = [];
		for(var i = 0; i < 3; i++){
				for(var j = 0; j < 3 ; j++){


						smallerBoxes.push({width: box.width/3, height:box.height/3, xpos: box.xpos + i * box.width/3, ypos : box.ypos + j*box.height/3});
				}
		}


		return smallerBoxes;
}


function drawSquare(canvas, box, lineWidth){
		var ctx = canvas.getContext("2d");

		ctx.beginPath();
		ctx.lineWidth= lineWidth;	
		ctx.rect(box.xpos,box.ypos,box.width,box.height);
		ctx.stroke();
}

function updateSudoku(canvas, preNumbers, marker){
		var ctx = canvas.getContext("2d");
		ctx.clearRect(0,0,canvas.width ,canvas.height);

		drawSudoku(canvas, preNumbers, marker);


		var lineWidth = 5;	
		drawSquare(canvas, globalMarkerBox, lineWidth);

}

updateSudoku(canvas, globalPreNumbers, globalMarkerBox);
function showAnswer(){


		getAnswer(globalPreNumbers.filter(function(cell){
				return cell.value !== 0;}));
}


		</script>
</html>

